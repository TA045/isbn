<!DOCTYPE html>
<html lang="ja">
  <head>
    <meta charset="utf-8">
    <title>æœ¬ã®è¡¨ç´™ã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã™ã‚‹</title>
    <style>
    body {
      font-family: "Helvetica Neue", "Helvetica", sans-serif;
      font-size: 1em;
      line-height: 1.5em;
      margin: 2em auto;
      max-width: 90%;
      background-color: whitesmoke;
    }
    .note { font-style: italic; }
    .header {
      max-width: 100%;
      margin-left: auto;
      margin-top: 5px;
      margin-bottom: 10px;
    }
    input {
      font-size: 1.2em;
      border-radius: .42em;
      padding: .36em;
    }
    #bookImageUrl img {
      max-width: 500px;
      cursor: pointer;
    }
    #bookHistory ul {
      padding-left: 1em;
    }
    #bookHistory li {
      list-style: none;
      margin-bottom: 0.5em;
      border-bottom: 1px solid #eee;
      padding-bottom: 0.2em;
      flex-basis: 150px;
      display: flex;
      flex-direction: column;
      align-items: center;
      text-align: center;
      position: relative;
    }
    #bookHistory li img {
      max-height: 125px;
      cursor: pointer;
      display: block;
      margin-bottom: 5px;
    }
    </style>
  </head>

  <body>
    <header class="header">
      <h2>æœ¬ã®è¡¨ç´™ã‚’DLã™ã‚‹ ğŸ“•</h2>
    </header>

    <h3>ISBN ã‚’å…¥åŠ› âœï¸</h3>
    <form>
      <input type="input" id="isbn" value="9784" oninput="onIsbnInput()" />
    </form>

    <h3>è¡¨ç´™</h3>
    <div id="bookStatus"></div>
    <div id="bookTitle"></div>
    <div id="bookImageUrl"></div>

    <h3>å±¥æ­´ ğŸ“š</h3>
    <div id="bookHistory"></div>

    <script>
      function i13to10(isbn_s) {
        let sum = 0;
        let chkDgt;
        let dgts = [];
        dgts = isbn_s.slice(3, -1).split("");
        for (let i = 0; i < 9; i++) sum += dgts[i] * (10 - i);
        chkDgt = 11 - (sum % 11);
        if (chkDgt === 10) chkDgt = "X";
        else if (chkDgt === 11) chkDgt = 0;
        dgts.push(chkDgt);
        return dgts.join("");
      }

      function bookStatus(msg) {
        document.getElementById("bookStatus").innerHTML = msg;
      }
      function bookTitle(msg) {
        document.getElementById("bookTitle").innerHTML = msg;
      }

      function downloadImage(image, bookName) {
        const imageUrl = window.URL.createObjectURL(image);
        const downloadLink = document.createElement("a");
        downloadLink.href = imageUrl;
        downloadLink.download = bookName;
        downloadLink.click();
        window.URL.revokeObjectURL(imageUrl);
      }

      // base64å¤‰æ›
      function blobToBase64(blob) {
        return new Promise((resolve, reject) => {
          const reader = new FileReader();
          reader.onloadend = () => resolve(reader.result);
          reader.onerror = reject;
          reader.readAsDataURL(blob);
        });
      }

      // å±¥æ­´ã«è¿½åŠ ã—ã¦ localStorage ã«ä¿å­˜
      async function addHistory(bookName, base64Image) {
        const historyDiv = document.getElementById("bookHistory");
        const historyList =
          historyDiv.querySelector("ul") || document.createElement("ul");

        historyList.style.display = "flex";
        historyList.style.flexWrap = "wrap";
        historyList.style.gap = "1em";
        historyList.style.padding = "0";

        const listItem = document.createElement("li");

        const imgElement = document.createElement("img");
        imgElement.src = base64Image;
        imgElement.onclick = () => {
          const link = document.createElement("a");
          link.href = base64Image;
          link.download = bookName;
          link.click();
        };

        const deleteButton = document.createElement("span");
        deleteButton.textContent = "âœ–ï¸";
        deleteButton.style.cursor = "pointer";
        deleteButton.style.position = "absolute";
        deleteButton.style.bottom = "0";
        deleteButton.style.right = "0";
        deleteButton.style.padding = "5px";
        deleteButton.style.fontSize = "10px";
        deleteButton.onclick = (e) => {
          e.stopPropagation();
          listItem.remove();
          removeFromStorage(bookName);
        };

        listItem.appendChild(imgElement);
        listItem.appendChild(deleteButton);
        historyList.prepend(listItem);

        if (!historyDiv.querySelector("ul")) {
          historyDiv.appendChild(historyList);
        }

        saveToStorage(bookName, base64Image);
      }

      // localStorage ä¿å­˜
      function saveToStorage(bookName, base64Image) {
        const data = JSON.parse(localStorage.getItem("bookHistory") || "[]");
        // æ—¢ã«åŒã˜æœ¬ãŒã‚ã‚‹å ´åˆã¯å‰Šé™¤ã—ã¦ä¸Šã«è¿½åŠ 
        const filtered = data.filter((b) => b.name !== bookName);
        filtered.unshift({ name: bookName, img: base64Image });
        localStorage.setItem("bookHistory", JSON.stringify(filtered));
      }

      // localStorage å‰Šé™¤
      function removeFromStorage(bookName) {
        const data = JSON.parse(localStorage.getItem("bookHistory") || "[]");
        const filtered = data.filter((b) => b.name !== bookName);
        localStorage.setItem("bookHistory", JSON.stringify(filtered));
      }

      // localStorage èª­ã¿è¾¼ã¿
      function loadHistory() {
        const data = JSON.parse(localStorage.getItem("bookHistory") || "[]").reverse();
        data.forEach((item) => addHistory(item.name, item.img));
      }

      async function onIsbnInput() {
        const isbn = document.getElementById("isbn").value;
        if (isbn.length < 13) {
          bookStatus(`ISBNã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚ã‚ã¨ ${13 - isbn.length} æ–‡å­—`);
          bookTitle("");
          document.getElementById("bookImageUrl").innerHTML = "";
          return;
        }

        const regex = /^978[\dX]{10}$/;
        if (!isbn.match(regex)) {
          bookStatus("ISBNã¯13æ¡ã®æ•°å­—ã§978ã‹ã‚‰å§‹ã¾ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚");
          return;
        }

        bookStatus("");
        bookTitle("");
        document.getElementById("bookImageUrl").innerHTML = "";

        let title = "";
        let authors = "";

        // openBD API
        const openbdApi = "https://api.openbd.jp/v1/get?isbn=";
        const response = await fetch(openbdApi + isbn).then((r) => r.json());
        if (response[0]) {
          title = response[0].summary.title;
          authors = response[0].summary.author
            .replace(/,/g, "")
            .replace(/\d{4}-/g, "")
            .replace(/\s/g, "_");
        }

        // Google Books API
        const googleBookApi = "https://www.googleapis.com/books/v1/volumes?q=isbn:";
        try {
          const res = await fetch(googleBookApi + isbn);
          const data = await res.json();
          if (data.totalItems) {
            const info = data.items[0].volumeInfo;
            if (!title) title = info.title;
            if (!authors && info.authors) authors = info.authors.join("_");
          }
        } catch (e) {
          console.log("Google Books API error:", e);
        }

        const isbn10 = i13to10(isbn);
        const amazonbookImageUrl =
          "https://images-na.ssl-images-amazon.com/images/P/";
        const bookImageUrl = `${amazonbookImageUrl}${isbn10}.09.LZZZZZZZ`;

        const bookName = title || authors ? `${isbn}_${title}_${authors}` : isbn;
        bookTitle(bookName);

        bookStatus("ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ä¸­...");
        const dl = await fetch(bookImageUrl);
        if (!dl.ok) {
          bookStatus("ç”»åƒãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸã€‚");
          return;
        }
        const image = await dl.blob();
        bookStatus("");

        if (image.size > 50) {
          const base64Image = await blobToBase64(image);
          const imgElement = document.createElement("img");
          imgElement.src = base64Image;
          imgElement.alt = bookName;
          imgElement.onclick = () => downloadImage(image, bookName);
          document.getElementById("bookImageUrl").innerHTML = "";
          document.getElementById("bookImageUrl").appendChild(imgElement);

          addHistory(bookName, base64Image);
          document.getElementById("isbn").value = "9784";
        } else {
          bookStatus("ç”»åƒãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸã€‚");
          document.getElementById("bookImageUrl").innerHTML = "";
          document.getElementById("isbn").value = "9784";
        }
      }

      // ãƒšãƒ¼ã‚¸ãƒ­ãƒ¼ãƒ‰æ™‚ã«å±¥æ­´ã‚’èª­ã¿è¾¼ã‚€
      window.onload = loadHistory;
    </script>
  </body>
</html>
